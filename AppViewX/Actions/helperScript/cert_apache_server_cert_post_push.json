{"name":"cert_apache_server_cert_post_push","scriptType":"Python","scriptContent":"#!Python/bin/python\n\nimport sys\nimport base64\nimport requests\nimport os\nimport time\nfrom requests.packages.urllib3.exceptions import InsecureRequestWarning\nrequests.packages.urllib3.disable_warnings(InsecureRequestWarning)\nimport json\nimport pfx_to_pem as ptp\nimport traceback\nfrom cert_helper import *\npolicy = {\n\t\"POWERSHELL\" : 1,\n\t\"WMI\" : 2\n}\nheader = {\"Content-Type\":\"application/json\"}\ntrue = \"true\"\nfalse = \"false\"\n\ndef change_server_certificate(request, pem_file):\n\t\"\"\"To change server certificate.\"\"\"\n\tapi = '/changeServerCert'\n\tport = request[\"vendorAuth\"][\"vendorDetails\"][\"anythingElse\"][\"restAgentPort\"]\n\tagent_url = \"https://\" + request['vendorAuth'][\"vendorDetails\"][\"host\"] + \":\" + port + api\n\tserverCertContent = request[\"certificateFile\"][\"content\"]\n\tserverKeyContent = request[\"privateKeyFile\"][\"content\"]\n\tpayload = {\n\t\t'serverCertContent' : serverCertContent,\n\t\t'serverKeyContent' : serverKeyContent\n\t}\n\traw_response = requests.post(agent_url, data=json.dumps(payload), headers=header, verify=False, cert=pem_file)\n\tif raw_response.status_code != 200:\n\t\traise Exception(str(raw_response))\n\tresponse = raw_response.json()\n\tresponse = response[\"result\"]\n\tif not response:\n\t\traise Exception(\"Change server certificate failed\")\n\n\nif __name__ == '__main__':\n\trequest = sys.argv[1]\n\ttry:\n\t\trequest = decode_input_pem(request)\n\t\tpem_file = ptp.pfx_2_pem(request)\n\t\tchange_server_certificate(request, pem_file)\n\t\tupdate_device_status_message(request,'Success','Server certificate : Bind to Rest Agent','Rest Agent Server certificate changed succesfully')\n\t\ttrigger_push_to_client_cert(request['vendorAuth']['vendorDetails']['name'])\n\t\tupdate_device_status_message(request,'Success','Server certificate : Trigger Client certificate process','Client certificate push API triggered from Server certificate post push')\n\t\tprint('AppResponseCode:0')\n\texcept Exception as e:\n\t\tupdate_device_status_message(request,'Failure','Server certificate : Post push process','Problem in server certificate post push : '+str(e))\n\t\ttraceback.print_exc()\n\n","description":"","readOnly":false,"version":"Version 2.x","historyReferences":[],"usedHistory":null,"sourceControlSettings":null,"_id":"cert_apache_server_cert_post_push","_keywords":["cert_apache_server_cert_post_push","","Version 2.x"]}