{"name":"create_and_send_policy_xml_vw","scriptType":"Python","scriptContent":"#!../Python/bin/python\nimport os\nimport sys\nimport paramiko\nimport socket\ninputs = sys.argv\nabs_path = os.path.dirname(os.path.abspath(__file__))\ndecrypt_path = abs_path+\"/../../aps/helper\"\nsys.path.insert(0, decrypt_path)\n\nimport appviewx\nfrom Decrypt_Python3 import getpassword, getencoded\nimport asm_migration_directory_vw as asm_migration_directory\nimport asm_file_path_vw as asm_file_path\n\navx_ip = socket.gethostbyname(socket.gethostname())\nhome_directory = asm_migration_directory.return_directory_path()\nconnect_db = appviewx.db_connection()\navx_path = asm_file_path.return_path()+'/../../'\n\ndef get_device_ip(dev_name):\n    db = connect_db.appviewx\n    collection = db.device\n    try :\n        for val in collection.find({\"name\":dev_name}):\n            return val[\"ip\"]\n    except KeyError :\n        pass\n\ndef export_policy_from_device_to_avx(device_name,file_name):\n    global policy_name\n    uname,pwd = getpassword(device_name)\n    generate_asm_xml = \"tmsh save asm policy \"+policy_name+\" xml-file \"+file_name\n    try:\n        trans = paramiko.Transport((get_device_ip(device_name), 22))\n        trans.connect(username=uname, password=pwd)\n        print(str(trans))\n        session = trans.open_channel(\"session\")\n        paramiko.util.log_to_file(\"asm_policy_migration_paramiko.log\")\n        session.exec_command(generate_asm_xml)\n        session.recv_exit_status()\n        print('before while')\n        while session.recv_ready():\n            print('inside while')\n            sftp = paramiko.SFTPClient.from_transport(trans)\n            remote_path = \"/var/tmp/\"+file_name\n            local_path = home_directory+file_name\n            sftp.get(remote_path, local_path)\n            if session.recv_ready() :\n                trans.close()\n                break\n    except paramiko.AuthenticationException as e:\n        print(e)\n\ndef import_policy_to_device_from_avx(device_name,file_name):\n    global policy_name\n    uname,pwd = getpassword(device_name)\n    try:\n        trans1 = paramiko.Transport((get_device_ip(device_name), 22))\n        trans1.connect(username=uname, password=pwd)\n        session = trans1.open_channel(\"session\")\n        paramiko.util.log_to_file(\"filename.log\")\n        sftp = paramiko.SFTPClient.from_transport(trans1)\n        remote_path = \"/var/tmp/\"+file_name\n        local_path = home_directory+file_name\n        sftp.put(local_path,remote_path)\n        if session.recv_ready() :\n            trans1.close()\n    except paramiko.AuthenticationException:\n        sys.exit(1)\n\nif __name__ == \"__main__\":\n    source_device = inputs[1]\n    policy_name = inputs[2]\n    device_name = inputs[3]\n    filename = inputs[4]\n    export_policy_from_device_to_avx(source_device,filename)\n    import_policy_to_device_from_avx(device_name,filename)","description":"","readOnly":false,"version":"Version 2.x","historyReferences":[],"usedHistory":null,"sourceControlSettings":null,"_id":"create_and_send_policy_xml_vw","_keywords":["create_and_send_policy_xml_vw","","Version 2.x"]}