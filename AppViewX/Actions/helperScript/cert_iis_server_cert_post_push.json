{"name":"cert_iis_server_cert_post_push","scriptType":"Python","scriptContent":"#!Python/bin/python\n\nimport os\nimport sys\nimport requests\nfrom requests.packages.urllib3.exceptions import InsecureRequestWarning\nrequests.packages.urllib3.disable_warnings(InsecureRequestWarning)\nimport json\nimport traceback\nfrom cert_helper import *\nimport pfx_to_pem as ptp\n\npolicy = {\n\t\"POWERSHELL\" : 1,\n\t\"WMI\" : 2\n}\nheader = {\"Content-Type\":\"application/json\"}\n\n\ndef change_server_certificate(request, pem_file):\n\t\"\"\"To change server certificate.\"\"\"\n\tapi = '/rest/BindCertificateToGateway'\n\tagent_url = request['vendorAuth'][\"agentUrl\"] + api\n\tselected_policy = request['vendorAuth'][\"vendorDetails\"]['anythingElse']['windowsGateway']['type']\n\tcertificate_hash = request['certificate'][\"extension\"]['thumbPrint'].replace(':','')\n\tpayload = {\n\t\t'policy' : policy[selected_policy],\n\t\t'CertificateHash' : certificate_hash\n\t}\n\traw_response = requests.post(agent_url, data=json.dumps(payload), headers=header, verify=False, cert=pem_file)\n\tif raw_response.status_code != 200:\n\t\traise Exception(str(raw_response))\n\tif raw_response.text != 'true':\n\t\traise Exception(str(raw_response.text))\n\n\nif __name__ == '__main__':\n\trequest = sys.argv[1]\n\ttry:\n\t\trequest = decode_input_pem(request)\n\t\tpem_file = ptp.pfx_2_pem(request)\n\t\tchange_server_certificate(request, pem_file)\n\t\tupdate_device_status_message(request,'Success','Server certificate : Bind to gateway','Gateway Server certificate changed succesfully')\n\t\ttrigger_push_to_client_cert(request['vendorAuth']['vendorDetails']['name'])\n\t\tupdate_device_status_message(request,'Success','Server certificate : Trigger Client certificate process','Client certificate push API triggered from Server certificate post push')\n\t\tprint('AppResponseCode:0')\n\texcept Exception as e:\n\t\tupdate_device_status_message(request,'Failure','Server certificate : Post push process','Problem in server certificate post push : '+str(e))\n\t\ttraceback.print_exc()\n\n","description":"","readOnly":false,"version":"Version 2.x","historyReferences":[],"usedHistory":null,"sourceControlSettings":null,"_id":"cert_iis_server_cert_post_push","_keywords":["cert_iis_server_cert_post_push","","Version 2.x"]}