{"name":"cert_apache_client_cert_post_push","scriptType":"Python","scriptContent":"#!Python/bin/python\nimport os\nimport sys\nimport base64\nimport requests\nimport time\nfrom requests.packages.urllib3.exceptions import InsecureRequestWarning\nrequests.packages.urllib3.disable_warnings(InsecureRequestWarning)\nimport json\nfrom cert_helper import *\nimport pfx_to_pem as ptp\nimport re\nimport traceback\npolicy = {\n\t\"POWERSHELL\" : 1,\n\t\"WMI\" : 2\n}\nheader = {\"Content-Type\":\"application/json\"}\ntrue = \"true\"\nfalse = \"false\"\n\n\ndef change_client_certificate(request, pem_file):\n\t\"\"\"To change server certificate.\"\"\"\n\tapi = '/changeClientCert'\n\tport = request[\"vendorAuth\"][\"vendorDetails\"][\"anythingElse\"][\"restAgentPort\"]\n\tagent_url = \"https://\" + request['vendorAuth'][\"vendorDetails\"][\"host\"] + \":\" + port + api\n\tcaCerts = [content[\"content\"] for content in request[\"caCerts\"]]\n\tpayload = {\n\t\t'caCerts' : caCerts\n\t\t\n\t}\n\traw_response = requests.post(agent_url, data=json.dumps(payload), headers=header, verify=False, cert=pem_file)\n\tif raw_response.status_code != 200:\n\t\traise Exception(str(raw_response))\n\tresponse = raw_response.json()\n\tresponse = response[\"result\"]\n\tif not response:\n\t\traise Exception(\"Change client certificate failed\")\n\n\t\ndef map_client_device(request):\n\t\"\"\"Map Client to Device.\"\"\"\n\tgwurl, gwkey, gwsource = get_gwinfo()\n\tapi = 'avxapi/map-default-client-cert-to-device'\n\turl = gwurl + api + '?gwkey={}&gwsource={}'.format(gwkey, gwsource)\n\tpayload = {\"payload\":{\"deviceName\":request['vendorAuth']['vendorDetails']['name']}}\n\traw_response = requests.put(url, data=json.dumps(payload), headers=header, verify=False)\n\tif raw_response.status_code != 200:\n\t\traise Exception(raw_response.text)\n\ndef restart_agent(request, pem_file):\n\t\"\"\"To restart agent with default client certificate.\"\"\"\n\tapi = '/restartAgent'\n\tport = request[\"vendorAuth\"][\"vendorDetails\"][\"anythingElse\"][\"restAgentPort\"]\n\tagent_url = \"https://\" + request['vendorAuth'][\"vendorDetails\"][\"host\"] + \":\" + port + api\n\tpayload = {}\n\traw_response = requests.post(agent_url, data=json.dumps(payload), headers=header, verify=False, cert=pem_file)\n\tif raw_response.status_code != 200:\n\t\traise Exception(str(raw_response))\n\tresponse = raw_response.json()\n\tresponse = response[\"result\"]\n\tif not response:\n\t\traise Exception(\"Restart agent failed\")\n\n\n\nif __name__ == '__main__':\n\trequest = sys.argv[1]\n\ttry:\n\t\trequest = decode_input_pem(request)\n\t\tpem_file = ptp.pfx_2_pem(request)\n\t\tchange_client_certificate(request, pem_file)\n\t\t\n\t\tupdate_device_status_message(request,'Success','Client certificate : Bind default client certificate','Default client certificate added to server')\n\t\tmap_client_device(request)\n\t\tupdate_device_status_message(request,'Success','Client certificate : Switch authentication to default client certificate','Device will use default client certificate for further communication')\n\t\trestart_agent(request, pem_file)\n\t\tupdate_device_status_message(request,'Success','Client certificate : Restart Agent','Agent restarted triggered with default client certificate')\n\t\tprint('AppResponseCode:0')\n\texcept Exception as e:\n\t\tupdate_device_status_message(request,'Failure','Client certificate : Post push process','Problem encountered in client certificate post push : '+str(e))\n\t\ttraceback.print_exc()\n\n\n","description":"","readOnly":false,"version":"Version 2.x","historyReferences":[],"usedHistory":null,"sourceControlSettings":null,"_id":"cert_apache_client_cert_post_push","_keywords":["cert_apache_client_cert_post_push","","Version 2.x"]}